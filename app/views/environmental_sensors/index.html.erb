<div class="container-fluid mt-4">
  <%= turbo_stream_from "environmental_sensors_updates" %>
  <%= turbo_stream_from "environmental_dashboard" %>

  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h1 class="h2">Environmental Sensors</h1>
        <div>
          <%= link_to search_environmental_sensors_path, class: "btn btn-success me-2" do %>
            <i class="bi bi-search"></i>
            Search for sensors
          <% end %>
          <%= link_to environmental_alerts_path, class: "btn btn-outline-warning me-2" do %>
            <i class="bi bi-exclamation-triangle"></i>
            Alerts
            <% if @active_alerts_count && @active_alerts_count > 0 %>
              <span id="environmental_alerts_count" class="badge bg-danger"><%= @active_alerts_count %></span>
            <% end %>
          <% end %>
          <%= link_to dashboards_path, class: "btn btn-outline-primary" do %>
            <i class="bi bi-house"></i>
            Dashboard
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Row -->
  <div class="row mb-3">
    <div class="col-12">
      <div class="card">
        <div class="card-body">
          <%= form_with url: environmental_sensors_path, method: :get, class: "row g-3" do |f| %>
            <div class="col-md-3">
              <%= f.label :sensor_type, "Sensor Type", class: "form-label" %>
              <%= f.select :sensor_type,
                  options_for_select([
                    ["All Types", ""],
                    ["Air Quality", "air_quality"],
                    ["Temperature", "temperature"],
                    ["Humidity", "humidity"],
                    ["Water Quality", "water_quality"]
                  ], params[:sensor_type]),
                  {}, class: "form-select" %>
            </div>

            <div class="col-md-3">
              <%= f.label :status, "Status", class: "form-label" %>
              <%= f.select :status,
                  options_for_select([
                    ["All Status", ""],
                    ["Active", "active"],
                    ["Inactive", "inactive"],
                    ["Maintenance", "maintenance"]
                  ], params[:status]),
                  {}, class: "form-select" %>
            </div>

            <div class="col-md-3">
              <%= f.label :location_id, "Location", class: "form-label" %>
              <%= f.select :location_id,
                  options_from_collection_for_select(Location.all, :id, :name, params[:location_id]),
                  { include_blank: "All Locations" }, class: "form-select" %>
            </div>

            <div class="col-md-3 d-flex align-items-end">
              <%= f.submit "Filter", class: "btn btn-primary me-2" %>
              <%= link_to "Reset", environmental_sensors_path, class: "btn btn-outline-secondary" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Map and List Row -->
  <div class="row">
    <!-- Map Column -->
    <div class="col-lg-8 mb-4">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <i class="bi bi-map"></i>
            Sensor Locations
          </h5>
          <span class="badge bg-info"><%= @sensors.count %> sensors</span>
        </div>
        <div class="card-body p-0">
          <div
            data-controller="map"
            data-map-sensors-value="<%= @sensors.map { |s| {
              id: s.id,
              name: s.name,
              latitude: s.latitude,
              longitude: s.longitude,
              sensor_type: s.sensor_type,
              status: s.status,
              latest_reading: s.latest_reading ? {
                value: s.latest_reading.value,
                unit: s.latest_reading.unit
              } : nil
            } }.to_json %>"
            data-map-zoom-value="10"
            style="height: 500px;"
          >
            <div data-map-target="container" style="height: 100%; width: 100%;"></div>
          </div>
        </div>
      </div>
    </div>

    <!-- Sensor List Column -->
    <div class="col-lg-4 mb-4">
      <div class="card">
        <div class="card-header">
          <h5 class="mb-0">
            <i class="bi bi-list-ul"></i>
            Sensor List
          </h5>
        </div>
        <div class="card-body" style="max-height: 500px; overflow-y: auto;">
          <% if @sensors.any? %>
            <div id="sensors_list" class="list-group list-group-flush">
              <% @sensors.each do |sensor| %>
                <%= render partial: "sensor_card", locals: { sensor: sensor } %>
              <% end %>
            </div>

            <!-- Pagination -->
            <div class="mt-3">
              <%== pagy_bootstrap_nav(@pagy) if defined?(@pagy) %>
            </div>
          <% else %>
            <div class="alert alert-info">
              <i class="bi bi-info-circle"></i>
              No sensors found. <%= link_to "Search for sensors", search_environmental_sensors_path, class: "alert-link" %> to import from OpenAQ, or adjust your filters.
            </div>
          <% end %>
        </div>
      </div>
    </div>
  </div>

  <!-- Summary Statistics Row -->
  <div class="row mt-4">
    <div class="col-md-3 mb-3">
      <div class="card text-white bg-primary">
        <div class="card-body">
          <h6 class="card-title">Total Sensors</h6>
          <h2 class="mb-0"><%= EnvironmentalSensor.count %></h2>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card text-white bg-success">
        <div class="card-body">
          <h6 class="card-title">Active Sensors</h6>
          <h2 class="mb-0"><%= EnvironmentalSensor.active.count %></h2>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card text-white bg-info">
        <div class="card-body">
          <h6 class="card-title">Total Readings</h6>
          <h2 class="mb-0"><%= EnvironmentalReading.count %></h2>
        </div>
      </div>
    </div>

    <div class="col-md-3 mb-3">
      <div class="card text-white bg-warning">
        <div class="card-body">
          <h6 class="card-title">Active Alerts</h6>
          <h2 class="mb-0"><%= EnvironmentalAlert.active.count %></h2>
        </div>
      </div>
    </div>
  </div>
</div>
